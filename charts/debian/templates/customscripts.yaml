---
apiVersion: v1
kind: ConfigMap
metadata:
  name: customscripts
  namespace: debian
data:
  install-packages.bash: |
    #!/bin/bash

    set -x
    set -e
    
    chmod 1777 /tmp

    apt --yes --force-yes update
    apt --yes --force-yes full-upgrade


    apt --yes --force-yes install openssh-server

    sed -i 's/#Port 22/Port 2222/g' /etc/ssh/sshd_config
    sed -i 's/#ClientAliveInterval 0/ClientAliveInterval 2/g' /etc/ssh/sshd_config

    {{- if .Values.packages }}
    apt install --yes --force-yes {{- range .Values.packages }} {{ . }}{{- end }}
    {{- end }}

    {{- if .Values.sshkeys }}
      {{- range .Values.sshkeys }}
    echo {{ . | quote }} >> /root/.ssh/authorized_keys
      {{- end }}
    {{- end }}


    /etc/init.d/ssh start

    apt --yes --force-yes purge systemd
    apt --yes --force-yes autoremove
    apt --yes --force-yes clean

