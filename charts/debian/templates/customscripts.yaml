---
apiVersion: v1
kind: ConfigMap
metadata:
  name: customscripts
  namespace: debian
data:
  install-packages.bash: |
    #!/bin/bash
    
    chmod 1777 /tmp

    apt -qq update
    apt -qq full-upgrade


    apt -y -qq install openssh-server

    sed -i 's/#Port 22/Port 2222/g' /etc/ssh/sshd_config
    sed -i 's/#ClientAliveInterval 0/ClientAliveInterval 2/g' /etc/ssh/sshd_config

    {{- if .Values.packages }}
    apt install -y -qq {{- range .Values.packages }} {{ . }}{{- end }}  
    {{- end }}

    {{- if .Values.sshkeys }}
      {{- range .Values.sshkeys }}
    echo {{ . | quote }} >> /root/ssh/authorized_keys
      {{- end }}
    {{- end }}


    /etc/init.d/ssh start

    apt -qq -y purge systemd
    apt -qq -y autoremove
    apt -qq -y clean

