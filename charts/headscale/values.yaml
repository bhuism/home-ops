defaultPodOptions:
  shareProcessNamespace: true

controllers:
  main:
    initContainers:
      create-etc-headscale:
        image:
          pullPolicy: IfNotPresent
          repository: alpine
          tag: 3.21.3
        command:
          - sh
          - -c
          - |
            echo 'Writing empty config' >&2              
            mkdir -p "/etc/headscale"
            chmod 755 "/etc/headscale"
            cat <<- 'EOF' >"/etc/headscale/config.yaml"

            server_url: https://headscale.impl.nl
            listen_addr: 127.0.0.1:8080
            metrics_listen_addr: 127.0.0.1:9090
            grpc_listen_addr: 127.0.0.1:50443
            grpc_allow_insecure: false

            noise:
              private_key_path: /var/lib/headscale/noise_private.key
            prefixes:
              v4: 100.64.0.0/10
              allocation: sequential

            derp:
              server:
                enabled: false
              urls:
                - https://controlplane.tailscale.com/derpmap/default
              auto_update_enabled: true
              update_frequency: 24h

            disable_check_updates: true

            # Time before an inactive ephemeral node is deleted?
            ephemeral_node_inactivity_timeout: 30m

            database:
              type: sqlite
              sqlite:
                path: /var/lib/headscale/db.sqlite

            log:
              # Output formatting for logs: text or json
              format: text
              level: info

            dns:
              magic_dns: false

            EOF

            chmod 644 /etc/headscale/config.yaml
            ls -lah /etc/headscale/config.yaml
            
    containers:
      main:
        image:
          pullPolicy: IfNotPresent
          repository: ghcr.io/juanfont/headscale
          tag: v0.25.1
        probes:
          liveness:
            enabled: true
          readiness:
            enabled: true
          startup:
            enabled: true
        env:
          TZ: "UTC"
        args: ["serve"]
      headplane:
        image:
          pullPolicy: IfNotPresent
          repository: ghcr.io/tale/headplane
          tag: 0.5.1
        probes:
          liveness:
            enabled: true
          readiness:
            enabled: true
          startup:
            enabled: true
        env:
          # Set these if the pod name for Headscale is not static
          # We will use the downward API to get the pod name instead
          HEADPLANE_LOAD_ENV_OVERRIDES: "true"
          HEADPLANE_INTEGRATION__KUBERNETES__POD_NAME:
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
service:
  main:
    controller: main
    ports:
      http:
        port: 8080
      metrics:
        port: 9090
      headplane:
        port: 3000
      grpc:
        port: 50443

ingress:
  main:
    enabled: true
    className: nginx-external
    annotations:
      external-dns.alpha.kubernetes.io/target: jasmine.odee.net
      external-dns.alpha.kubernetes.io/cloudflare-proxied: "false"
      cert-manager.io/cluster-issuer: letsencrypt-production
    hosts:
      - host: headscale.impl.nl
        paths:
          - path: /
            pathType: ImplementationSpecific
            service:
              identifier: main
              port: http
    tls:
      - secretName: headscale.impl.nl
        hosts:
          - headscale.impl.nl

persistence:
  config:
    enabled: true
    type: persistentVolumeClaim
    existingClaim: headscale-config
    globalMounts:
      - path: /etc/headscale

  data:
    enabled: true
    type: persistentVolumeClaim
    existingClaim: headscale-data
    advancedMounts:
      main:
        main:
          - path: /var/lib/headscale
