defaultPodOptions:
  shareProcessNamespace: true

controllers:
  main:
    initContainers:
      create-etc-headscale:
        image:
          pullPolicy: IfNotPresent
          repository: alpine
          tag: 3.21.3
        command:
          - sh
          - -c
          - |
            df
            if [[ -f "/etc/headscale/config.yaml" ]]; then
              echo 'Config already exists' >&2
            else
              echo 'Writing empty config' >&2              
              mkdir -p "/etc/headscale"
              cat <<- 'EOF' >"/etc/headscale/config.yaml"
            # use environment variables to configure Headscale.
            # For config reference, see https://github.com/juanfont/headscale/blob/main/config-example.yaml
            # To configure any of these as an env:
            #   1. Flatten object keys using "_"
            #   2. Prefix with "HEADSCALE_"
            #
            # For example:
            #   - "listen_addr" becomes "HEADSCALE_LISTEN_ADDR"
            #   - "log.level" becomes "HEADSCALE_LOG_LEVEL"
            EOF
            fi
    containers:
      main:
        image:
          pullPolicy: IfNotPresent
          repository: ghcr.io/juanfont/headscale
          tag: v0.25.1
        probes:
          liveness:
            enabled: true
          readiness:
            enabled: true
          startup:
            enabled: true
        env:
          HEADSCALE_SERVER_URL: https://headscale.impl.nl
          HEADSCALE_LISTEN_ADDR: "0.0.0.0:8080"
          HEADSCALE_METRICS_LISTEN_ADDR: "0.0.0.0:9090"
          HEADSCALE_PRIVATE_KEY_PATH: "/etc/headscale/private.key"
          HEADSCALE_NOISE: "{}"
          HEADSCALE_NOISE_PRIVATE_KEY_PATH: "/etc/headscale/noise_private.key"
          HEADSCALE_DATABASE_TYPE: "sqlite3"
          HEADSCALE_DATABASE_SQLITE_PATH: "/etc/headscale/db.sqlite"
        args: ["serve"]
service:
  main:
    controller: main
    ports:
      http:
        port: 8080
      metrics:
        port: 9090

ingress:
  main:
    enabled: true
    className: nginx-external
    annotations:
      external-dns.alpha.kubernetes.io/target: jasmine.odee.net
      external-dns.alpha.kubernetes.io/cloudflare-proxied: "false"
      cert-manager.io/cluster-issuer: letsencrypt-production
    hosts:
      - host: headscale.impl.nl
        paths:
          - path: /
            pathType: ImplementationSpecific
            service:
              identifier: main
              port: http
    tls:
      - secretName: headscale.impl.nl
        hosts:
          - headscale.impl.nl

persistence:
  config:
    enabled: true
    type: persistentVolumeClaim
    existingClaim: headscale-config
    globalMounts:
      - path: /etc/headscale

  data:
    enabled: true
    type: persistentVolumeClaim
    existingClaim: headscale-data
    advancedMounts:
      main:
        main:
          - path: /var/lib//headscale
