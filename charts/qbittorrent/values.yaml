---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/refs/heads/main/charts/library/common/values.schema.json

# Configure options applied to all pods
defaultPodOptions:
  automountServiceAccountToken: false

controllers:
  main:

    # Configure the pod-specific securityContext
    pod:
      securityContext:
        fsGroup: 568
        fsGroupChangePolicy: "OnRootMismatch"

    containers:
      # port-forward:
      #   dependsOn: gluetun
      #   image:
      #     repository: docker.io/snoringdragon/gluetun-qbittorrent-port-manager
      #     tag: "1.0"
      #   env:
      #     - name: QBITTORRENT_SERVER
      #       value: localhost
      #     - name: QBITTORRENT_PORT
      #       value: "8080"
      #     - name: PORT_FORWARDED
      #       value: "/tmp/gluetun/forwarded_port"

      main:
        image:
          repository: ghcr.io/onedr0p/qbittorrent
          tag: 5.0.4
        env:
          TZ: Europe/Amsterdam
        securityContext:
          runAsUser: 568
          runAsGroup: 568

      # Configure the gluetun sidecar
      gluetun:
        dependsOn: main
        image:
          repository: ghcr.io/qdm12/gluetun
          tag: v3.40.0
        env:
          TZ: Europe/Amsterdam
          VPN_SERVICE_PROVIDER: nordvpn
          VPN_TYPE: openvpn
          SERVER_COUNTRIES: Switzerland
          OPENVPN_USER:
            configMapKeyRef:
              name: nordvpn-credentials
              key: username
          OPENVPN_PASSWORD:
            configMapKeyRef:
              name: nordvpn-credentials
              key: password
          DNS_ADDRESS: 1.1.1.1
          FIREWALL_INPUT_PORTS: 8080

        securityContext:
          capabilities:
            add:
              - NET_ADMIN

service:
  main:
    controller: main
    type: ClusterIP
    ports:
      http:
        port: 8080

# ingress:
#   main:
#     className: "external-nginx"
#     hosts:
#       - host: qbittorent.impl.nl
#         paths:
#           - path: /
#             pathType: Prefix
#             service:
#               identifier: main
#               port: http
#     tls:
#       - hosts:
#           - *host

persistence:
  config:
    existingClaim: qbittorrent-config
    advancedMounts:
      main:
        main:
          - path: /config
  media:
    existingClaim: qbittorrent-media
    advancedMounts:
      main:
        main:
          - path: /media

  # Configure an emptyDir to share the port-forwarding location between containers
  # gluetun-data:
  #   type: emptyDir
  #   advancedMounts:
  #     main:
  #       gluetun:
  #         - path: /tmp/gluetun
        # port-forward:
        #   - path: /tmp/gluetun
        #     readOnly: true
