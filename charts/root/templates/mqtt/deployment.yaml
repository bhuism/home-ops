apiVersion: apps/v1
kind: Deployment
metadata:
  name: mosquitto
  namespace: mosquitto
  labels:
    app: mosquitto
spec:
  selector:
    matchLabels:
      app: mosquitto
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: mosquitto
    spec:
      initContainers:
        - name: create-config
          image: alpine
          command: [/bin/sh, -c]
          args:
            - |
              mkdir -pv /mosquitto/config
              chown -Rv 1883:1883 /mosquitto
              cat <<EOF > /mosquitto/config/mosquitto.conf
              listener 1883
              persistence true
              persistence_location /mosquitto/data/
              log_dest file /mosquitto/log/mosquitto.log
              allow_anonymous true
              EOF
      containers:
        - image: eclipse-mosquitto:2.0.18
          name: mosquitto
          ports:
            - containerPort: 1883
            - containerPort: 9001
          volumeMounts:
            - name: mosquitto-persistent-data-storage
              mountPath: /mosquitto/data
          securityContext:
            readOnlyRootFilesystem: false
      volumes:
        - name: mosquitto-persistent-data-storage
          persistentVolumeClaim:
            claimName: mosquitto-data-pvc
